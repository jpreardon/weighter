<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rewards!</title>
  </head>
  <body>
    <div class="container">
      <h1>Rewards!</h1>
      <p>The rewards app isn't so rewarding now, is it?</p>
      <p id="lastWeighInfo">Your weight on <span id="lastWeighDate"></span> was <span id="lastWeight"></span>.</p>
      <form method="POST" action="api/api.php/weight">
        <label for="date">Date</label>
        <input type="date" id="date" name="date" />
        <label for="weight">Weight</label>
        <input type="number" step="0.01" id="weight" name="weight" />
        <input type="submit" value="Submit" />
      </form>
    </div>

    <script>
      // Enter today's date in date field
      var today = new Date()
      var dd = today.getDate()
      var mm = today.getMonth()+1 //January is 0!
      var yyyy = today.getFullYear()
      
      if(dd<10) {
          dd = '0'+dd
      } 

      if(mm<10) {
          mm = '0'+mm
      } 

      today = yyyy + '-' + mm + '-' + dd
      document.getElementById("date").value = today

      // Get the last weight
      // TODO: This is error prone since the last element may not be the most recent date. This is a failing
      //       of both the API and the front end developer. The API needs to be, and will be replaced at some 
      //       point, but the front end could certainly compensate for it if the developer weren't so lazy.
      var xhr = new XMLHttpRequest()
      
      xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          var weights = JSON.parse(this.responseText)
          getLastWeight(weights)
        }
      }

      xhr.open("GET", "http://jpreardon.com/rewards/api/api.php/weight", true)
      xhr.send()

      function getLastWeight(weightsArray) {
        var lastRecord = weightsArray.weight.records.length - 1
        var dateIndex = 1
        var weightIndex = 2
        var lastWeighDate = weightsArray.weight.records[lastRecord][dateIndex]
        var lastWeight = weightsArray.weight.records[lastRecord][weightIndex]

        document.getElementById("lastWeighDate").innerHTML = lastWeighDate
        document.getElementById("lastWeight").innerHTML = lastWeight
        document.getElementById("lastWeighInfo").style.display = 'block'
      }

    </script>

    <style>
      body {
        font-family: sans-serif;
      }

      label, input[type="submit"] {
        display: block;
        margin-top: 1em;
        margin-bottom: .25em;
      }

      input[name="weight"] {
        width: 5em;
      }

      #lastWeighInfo {
        display: none;
      }
    </style>
  </body>
</html>