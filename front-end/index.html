<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rewards!</title>
  </head>
  <body>
    <div class="container">
      <h1>Rewards!</h1>
      <p id="lastWeighInfo">Your weight on <span id="lastWeighDate"></span> was <span id="lastWeight"></span>.</p>
      <form method="POST" action="" id="weightEntryForm">
        <label for="date">Date</label>
        <input type="date" id="date" name="date" />
        <label for="weight">Weight</label>
        <input type="number" step="0.01" id="weight" name="weight" />
        <!--<input type="submit" value="Submit" />-->
        <button type="button" onClick="sendData()">Submit</button>
      </form>
      <p id="responseMessage"></p>
    </div>

    <script>
      // Enter today's date in date field
      var today = new Date()
      var dd = today.getDate()
      var mm = today.getMonth()+1 //January is 0!
      var yyyy = today.getFullYear()
      
      if(dd<10) {
          dd = '0'+dd
      } 

      if(mm<10) {
          mm = '0'+mm
      } 

      today = yyyy + '-' + mm + '-' + dd
      document.getElementById("date").value = today

      // Get the last weight
      // TODO: This is error prone since the last element may not be the most recent date. This is a failing
      //       of both the API and the front end developer. The API needs to be, and will be replaced at some 
      //       point, but the front end could certainly compensate for it if the developer weren't so lazy.
      var xhr = new XMLHttpRequest()
      
      xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          var weights = JSON.parse(this.responseText)
          getLastWeight(weights)
        }
      }

      xhr.open("GET", "http://jpreardon.com/rewards/api/api.php/weight", true)
      xhr.send()

      function getLastWeight(weightsArray) {
        var lastRecord = weightsArray.weight.records.length - 1
        var dateIndex = 1
        var weightIndex = 2
        var lastWeighDate = weightsArray.weight.records[lastRecord][dateIndex]
        var lastWeight = weightsArray.weight.records[lastRecord][weightIndex]

        document.getElementById("lastWeighDate").innerHTML = lastWeighDate
        document.getElementById("lastWeight").innerHTML = lastWeight
        document.getElementById("lastWeighInfo").style.display = 'block'
      }

      function sendData() {
        var XHR = new XMLHttpRequest();
        var urlEncodedData = "";
        var urlEncodedDataPairs = [];
        var name;
        var date = document.getElementById("date")
        var weight = document.getElementById("weight")

        // Turn the data object into an array of URL-encoded key/value pairs.
        urlEncodedDataPairs.push(encodeURIComponent(date.name) + '=' + encodeURIComponent(date.value))
        urlEncodedDataPairs.push(encodeURIComponent(weight.name) + '=' + encodeURIComponent(weight.value))

        // Combine the pairs into a single string and replace all %-encoded spaces to 
        // the '+' character; matches the behaviour of browser form submissions.
        urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');

        // Define what happens on successful data submission
        XHR.addEventListener('load', function(event) {
          successfulSend(XHR.responseText)
        });

        // Define what happens in case of error
        XHR.addEventListener('error', function(event) {
          failSend()
        });

        // Set up our request
        XHR.open('POST', 'http://jpreardon.com/rewards/api/api.php/weight');

        // Add the required HTTP header for form data POST requests
        XHR.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        // Finally, send our data.
        XHR.send(urlEncodedData);
      }

      function successfulSend(responseText) {
        document.getElementById("weightEntryForm").style.display = "none"
        document.getElementById("lastWeighInfo").style.display = "none"

        var reponseMessage

        if (responseText == "null") {
          responseMessage = "A weight already exists for that date, enter a different date, or brush up on your SQL skilz..."
        } else {
          var lost = round(Number(document.getElementById("lastWeight").innerHTML) - Number(document.getElementById("weight").value), 2)

          if (lost > 0) {
            responseMessage = "Congrats! You lost " + lost.toString() + " pounds!"
          } else if (lost == 0) {
            responseMessage = "You lost nothing, call it a success."
          } else {
            responseMessage = "You gained <strong>" + lost.toString().substring(1) + " pounds</strong>! Get motivated!!!"
          }
          
        }

        document.getElementById("responseMessage").innerHTML = responseMessage
        document.getElementById("responseMessage").style.display = "block"
      }

      function failSend() {
        document.getElementById("weightEntryForm").style.display = "none"
        document.getElementById("lastWeighInfo").style.display = "none"

        var reponseMessage = "Something went horribly wrong, maybe try again."

        document.getElementById("responseMessage").innerHTML = responseMessage
        document.getElementById("responseMessage").style.display = "block"
      }

      function round(value, decimals) {
        return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
      }

    </script>

    <style>
      body {
        font-family: sans-serif;
      }

      label, input[type="submit"] {
        display: block;
        margin-top: 1em;
        margin-bottom: .25em;
      }

      input[name="weight"] {
        width: 5em;
      }

      #lastWeighDate, 
      #lastWeight {
        font-weight: bold;
      }

      #lastWeighInfo {
        display: none;
      }
    </style>
  </body>
</html>